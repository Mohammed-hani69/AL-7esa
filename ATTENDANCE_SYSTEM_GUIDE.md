# نظام الحضور والغياب ومعلومات الطلاب
## Attendance System and Student Information Management

## نظرة عامة | Overview

تم إضافة نظام شامل للحضور والغياب يتضمن:
- تسجيل الحضور اليومي للطلاب
- عرض معلومات الاتصال للطلاب
- إحصائيات الحضور والغياب
- التحقق من رقم هاتف ولي الأمر قبل الانضمام للفصول

## المميزات الجديدة | New Features

### 1. نظام تسجيل الحضور والغياب
- **للمعلمين والمساعدين**: إمكانية تسجيل حضور وغياب الطلاب يومياً
- **حالات الحضور المختلفة**: حاضر، غائب، متأخر، غياب بعذر
- **ملاحظات إضافية**: إمكانية إضافة ملاحظات لكل طالب
- **تسجيل تلقائي**: حفظ تاريخ ووقت تسجيل الحضور

### 2. معلومات الاتصال والتفاصيل
عند الضغط على أي طالب، يظهر للمعلم/المساعد:
- **معلومات الاتصال**:
  - رقم هاتف الطالب مع رابط اتصال مباشر
  - رقم هاتف ولي الأمر مع رابط اتصال مباشر
  - أزرار واتساب للطالب وولي الأمر
- **إحصائيات الحضور**:
  - عدد أيام الحضور
  - عدد أيام الغياب
  - عدد أيام التأخير
  - نسبة الحضور المئوية
- **الدرجات الأكاديمية**:
  - متوسط درجات الطالب في الفصل

### 3. إشعارات رقم هاتف ولي الأمر
- **للطلاب**: إشعار إجباري لإضافة رقم هاتف ولي الأمر قبل الانضمام لأي فصل
- **تحقق تلقائي**: منع الانضمام للفصول بدون رقم ولي الأمر
- **واجهة توجيهية**: توجيه الطلاب لتحديث ملفهم الشخصي

## الملفات المضافة | Added Files

### 1. نظام الحضور الخلفي
```
routes/attendance.py
```
- مسارات API لتسجيل وعرض الحضور
- تحقق من صلاحيات المعلم/المساعد
- إدارة بيانات الحضور في قاعدة البيانات

### 2. واجهات المستخدم
```
templates/attendance/mark_attendance.html
templates/attendance/attendance_report.html
```
- صفحة تسجيل الحضور اليومي
- تقرير شامل للحضور والغياب

### 3. JavaScript المتقدم
```
static/js/attendance-system.js
```
- نظام التحقق من رقم ولي الأمر
- دوال تسجيل الحضور التفاعلية
- البحث والفلترة في قوائم الطلاب

## كيفية الاستخدام | How to Use

### للمعلمين والمساعدين:

#### 1. تسجيل الحضور اليومي
```
/attendance/mark/{classroom_id}
```
- اختر حالة كل طالب (حاضر/غائب/متأخر/غياب بعذر)
- أضف ملاحظات إضافية عند الحاجة
- احفظ البيانات

#### 2. عرض معلومات الطالب
- اضغط على زر المعلومات بجانب اسم الطالب
- ستظهر نافذة منبثقة تحتوي على:
  - الصورة الشخصية والمعلومات الأساسية
  - أزرار الاتصال المباشر (هاتف + واتساب)
  - إحصائيات الحضور المفصلة
  - متوسط الدرجات

#### 3. تقرير الحضور الشامل
```
/attendance/report/{classroom_id}
```
- عرض إحصائيات شاملة لجميع الطلاب
- مقارنة أداء الطلاب في الحضور
- إمكانية التصدير (قيد التطوير)

### للطلاب:

#### 1. إضافة رقم هاتف ولي الأمر
- اذهب إلى "الملف الشخصي"
- أضف رقم هاتف ولي الأمر في الحقل المخصص
- احفظ التغييرات

#### 2. الانضمام للفصول
- إذا لم تُضف رقم ولي الأمر، ستظهر رسالة تنبيه
- لن تتمكن من الانضمام لأي فصل بدون رقم ولي الأمر
- بعد إضافة الرقم، يمكنك الانضمام للفصول بشكل طبيعي

## التحديثات على قاعدة البيانات | Database Updates

### 1. إضافة عمود google_id
```sql
ALTER TABLE user ADD COLUMN google_id VARCHAR(100);
CREATE UNIQUE INDEX uq_user_google_id ON user (google_id);
```
- إصلاح مشكلة تسجيل الدخول بـ Google
- دعم المصادقة بحسابات Google

### 2. جدول الحضور الموجود
```sql
-- جدول الحضور موجود بالفعل في models.py
class Attendance:
    - classroom_id: معرف الفصل
    - student_id: معرف الطالب  
    - date: تاريخ الحضور
    - status: حالة الحضور (present/absent/late/excused)
    - notes: ملاحظات إضافية
    - recorded_by: من سجل الحضور
```

## الأمان والصلاحيات | Security & Permissions

### 1. تحقق الصلاحيات
- **المعلمون**: يمكنهم تسجيل الحضور في فصولهم فقط
- **المساعدون**: يمكنهم تسجيل الحضور في الفصول المُعينين لها
- **الطلاب**: يمكنهم عرض حضورهم فقط

### 2. حماية البيانات
- جميع طلبات API محمية بنظام المصادقة
- تحقق من صحة البيانات قبل الحفظ
- منع الوصول غير المصرح به للمعلومات

## استكشاف الأخطاء | Troubleshooting

### 1. مشكلة Google OAuth
```
ERROR: Entity namespace for "user" has no property "google_id"
```
**الحل**: تم إضافة العمود المطلوب لقاعدة البيانات

### 2. عدم ظهور نظام الحضور
**التحقق من**:
- تم تسجيل `attendance_bp` في `app.py`
- الملفات موجودة في المجلد الصحيح
- إعادة تشغيل الخادم

### 3. عدم عمل التحقق من رقم ولي الأمر
**التحقق من**:
- تم تضمين `attendance-system.js` في الصفحات
- `userRole` متغير معرف صحيحاً
- مسار `/attendance/check-parent-phone` يعمل

## التطوير المستقبلي | Future Development

### المرحلة التالية:
1. **إشعارات تلقائية** لأولياء الأمور عند الغياب
2. **تقارير متقدمة** مع الرسوم البيانية
3. **تصدير البيانات** بصيغ مختلفة (Excel, PDF)
4. **إحصائيات شهرية وسنوية**
5. **نظام تحفيز** للحضور المنتظم

### تحسينات الأداء:
- تحسين استعلامات قاعدة البيانات
- إضافة فهارس للبحث السريع
- ذاكرة تخزين مؤقت للإحصائيات

## المساعدة والدعم | Help & Support

### للحصول على المساعدة:
1. راجع هذا الدليل أولاً
2. تحقق من سجلات الأخطاء في وحدة التحكم
3. تأكد من تشغيل آخر إصدار من النظام

### الاتصال:
- تحقق من صحة إعدادات قاعدة البيانات
- تأكد من صلاحيات المستخدم
- راجع إعدادات Firebase إذا لزم الأمر

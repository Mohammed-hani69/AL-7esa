<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <title>تقرير الحضور - {{ classroom.name }}</title>
    
    <!-- الخطوط وملفات CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.rtl.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.min.css">

    <style>
    /* متغيرات التصميم المخصص */
    :root {
        --primary-color: {{ primary_color or '#6366f1' }};
        --secondary-color: {{ secondary_color or '#8b5cf6' }};
        --accent-color: {{ primary_color or '#6366f1' }};
        --accent-gradient: linear-gradient(120deg, {{ primary_color or '#6366f1' }}, {{ secondary_color or '#8b5cf6' }});
        --surface-color: #FFFFFF;
        --background-color: #F4F7FE;
        --text-primary: #2D3748;
        --text-secondary: #718096;
        --border-radius-lg: 24px;
        --border-radius-md: 16px;
        --border-radius-sm: 8px;
        --box-shadow: 0 8px 25px -5px rgba(108, 99, 255, 0.15);
        --success-color: #10b981;
        --warning-color: #f59e0b;
        --danger-color: #ef4444;
        --info-color: #06b6d4;
    }

    /* تنسيق عام للموبايل */
    body {
        font-family: 'Tajawal', sans-serif;
        background: var(--background-color);
        margin: 0;
        padding: 0;
        min-height: 100vh;
        overflow-x: hidden;
    }

    /* الهيدر المحسن للموبايل */
    .mobile-header {
        background: var(--accent-gradient);
        color: white;
        padding: 1rem 1rem 2rem;
        position: sticky;
        top: 0;
        z-index: 100;
        box-shadow: var(--box-shadow);
    }

    .header-top {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }

    .back-btn {
        background: rgba(255,255,255,0.2);
        border: none;
        color: white;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.1rem;
    }

    .menu-btn {
        background: rgba(255,255,255,0.2);
        border: none;
        color: white;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.1rem;
    }

    .header-title {
        text-align: center;
        flex: 1;
        margin: 0 1rem;
    }

    .header-title h1 {
        font-size: 1.3rem;
        margin: 0;
        font-weight: 700;
    }

    .header-title small {
        opacity: 0.9;
        font-size: 0.9rem;
    }

    .header-filters {
        display: flex;
        gap: 0.5rem;
        justify-content: center;
    }

    .filter-select-mobile {
        background: rgba(255,255,255,0.2);
        border: 1px solid rgba(255,255,255,0.3);
        color: white;
        padding: 0.5rem;
        border-radius: var(--border-radius-sm);
        font-size: 0.8rem;
        backdrop-filter: blur(10px);
    }

    .filter-select-mobile option {
        background: var(--accent-color);
        color: white;
    }

    /* المحتوى الرئيسي */
    .mobile-content {
        padding: 1rem;
    }

    /* بطاقات الإحصائيات المحسنة للموبايل */
    .stats-grid-mobile {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    .stat-card-mobile {
        background: var(--surface-color);
        border-radius: var(--border-radius-md);
        padding: 1.5rem 1rem;
        text-align: center;
        position: relative;
        overflow: hidden;
        box-shadow: var(--box-shadow);
        transition: all 0.3s ease;
    }

    .stat-card-mobile::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: var(--accent-gradient);
    }

    .stat-card-mobile:hover {
        transform: translateY(-3px);
        box-shadow: 0 15px 30px rgba(99, 102, 241, 0.2);
    }

    .stat-icon-mobile {
        width: 50px;
        height: 50px;
        background: var(--accent-gradient);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        margin: 0 auto 1rem;
        font-size: 1.3rem;
    }

    .stat-number-mobile {
        font-size: 1.8rem;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 0.5rem;
        background: var(--accent-gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .stat-label-mobile {
        color: var(--text-secondary);
        font-size: 0.9rem;
        font-weight: 500;
    }

    /* الرسوم البيانية للموبايل */
    .charts-mobile {
        margin-bottom: 1.5rem;
    }

    .chart-container-mobile {
        background: var(--surface-color);
        border-radius: var(--border-radius-md);
        padding: 1rem;
        margin-bottom: 1rem;
        box-shadow: var(--box-shadow);
    }

    .chart-title-mobile {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 1rem;
        text-align: center;
    }

    .chart-canvas-mobile {
        height: 250px;
        width: 100%;
    }

    /* قائمة الطلاب المحسنة للموبايل */
    .students-section-mobile {
        margin-bottom: 1.5rem;
    }

    .section-header-mobile {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        padding: 0 0.5rem;
    }

    .section-title-mobile {
        font-size: 1.2rem;
        font-weight: 700;
        color: var(--text-primary);
        margin: 0;
    }

    .view-toggle-mobile {
        display: flex;
        background: var(--background-color);
        border-radius: var(--border-radius-sm);
        padding: 0.2rem;
    }

    .view-btn-mobile {
        padding: 0.5rem;
        border: none;
        background: transparent;
        color: var(--text-secondary);
        border-radius: var(--border-radius-sm);
        transition: all 0.3s ease;
    }

    .view-btn-mobile.active {
        background: var(--accent-color);
        color: white;
    }

    /* بطاقات الطلاب */
    .students-grid-mobile {
        display: grid;
        gap: 1rem;
    }

    .student-card-mobile {
        background: var(--surface-color);
        border-radius: var(--border-radius-md);
        padding: 1rem;
        box-shadow: var(--box-shadow);
        transition: all 0.3s ease;
    }

    .student-card-mobile:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(0,0,0,0.1);
    }

    .student-header-mobile {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 1rem;
    }

    .student-avatar-mobile {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        object-fit: cover;
        border: 3px solid var(--accent-color);
    }

    .student-placeholder-mobile {
        width: 60px;
        height: 60px;
        background: var(--accent-gradient);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.5rem;
    }

    .student-info-mobile h5 {
        margin: 0 0 0.25rem 0;
        font-weight: 600;
        color: var(--text-primary);
        font-size: 1.1rem;
    }

    .student-info-mobile small {
        color: var(--text-secondary);
        font-size: 0.85rem;
    }

    /* إحصائيات الطالب */
    .student-stats-mobile {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 0.5rem;
        margin-bottom: 1rem;
    }

    .stat-item-mobile {
        text-align: center;
        padding: 0.5rem;
        border-radius: var(--border-radius-sm);
        font-size: 0.8rem;
    }

    .stat-item-mobile.present {
        background: rgba(16, 185, 129, 0.1);
        color: var(--success-color);
    }

    .stat-item-mobile.late {
        background: rgba(245, 158, 11, 0.1);
        color: var(--warning-color);
    }

    .stat-item-mobile.absent {
        background: rgba(239, 68, 68, 0.1);
        color: var(--danger-color);
    }

    .stat-item-mobile.rate {
        background: rgba(99, 102, 241, 0.1);
        color: var(--accent-color);
    }

    .stat-value-mobile {
        font-weight: 700;
        font-size: 1rem;
        display: block;
    }

    /* أزرار العمليات */
    .student-actions-mobile {
        display: flex;
        gap: 0.5rem;
        justify-content: center;
    }

    .action-btn-mobile {
        flex: 1;
        padding: 0.75rem;
        border: none;
        border-radius: var(--border-radius-sm);
        font-size: 0.85rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        text-decoration: none;
    }

    .action-btn-mobile:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .btn-view-mobile {
        background: linear-gradient(120deg, #06b6d4, #0891b2);
        color: white;
    }

    .btn-contact-mobile {
        background: linear-gradient(120deg, #16a34a, #15803d);
        color: white;
    }

    /* عرض الجدول للموبايل */
    .table-view-mobile {
        display: none;
        background: var(--surface-color);
        border-radius: var(--border-radius-md);
        overflow: hidden;
        box-shadow: var(--box-shadow);
    }

    .table-view-mobile.active {
        display: block;
    }

    .table-mobile {
        width: 100%;
        font-size: 0.8rem;
    }

    .table-mobile th {
        background: var(--background-color);
        color: var(--text-primary);
        font-weight: 600;
        padding: 0.75rem 0.5rem;
        text-align: center;
        border: none;
        position: sticky;
        top: 0;
    }

    .table-mobile td {
        padding: 0.75rem 0.5rem;
        text-align: center;
        border-bottom: 1px solid var(--background-color);
        vertical-align: middle;
    }

    .table-mobile tr:hover {
        background: rgba(99, 102, 241, 0.05);
    }

    /* أزرار العمل السفلية */
    .bottom-actions-mobile {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: var(--surface-color);
        padding: 1rem;
        box-shadow: 0 -5px 15px rgba(0,0,0,0.1);
        display: flex;
        gap: 0.5rem;
        z-index: 50;
    }

    .btn-mobile {
        flex: 1;
        padding: 1rem;
        border: none;
        border-radius: var(--border-radius-sm);
        font-weight: 600;
        text-decoration: none;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        transition: all 0.3s ease;
        font-size: 0.9rem;
    }

    .btn-primary-mobile {
        background: var(--accent-gradient);
        color: white;
    }

    .btn-secondary-mobile {
        background: var(--background-color);
        color: var(--accent-color);
        border: 2px solid var(--accent-color);
    }

    /* قائمة جانبية للموبايل */
    .mobile-menu {
        position: fixed;
        top: 0;
        right: -300px;
        width: 300px;
        height: 100vh;
        background: var(--accent-gradient);
        color: white;
        z-index: 1000;
        transition: 0.3s ease;
        padding: 1rem;
        overflow-y: auto;
    }

    .mobile-menu.show {
        right: 0;
    }

    .menu-header {
        text-align: center;
        padding: 1rem 0 2rem;
        border-bottom: 1px solid rgba(255,255,255,0.2);
        margin-bottom: 1rem;
    }

    .menu-logo {
        width: 60px;
        height: 60px;
        background: rgba(255,255,255,0.2);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 1rem;
        font-size: 1.5rem;
    }

    .menu-items {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .menu-item {
        margin-bottom: 0.5rem;
    }

    .menu-link {
        display: flex;
        align-items: center;
        gap: 1rem;
        color: rgba(255,255,255,0.9);
        padding: 1rem;
        border-radius: var(--border-radius-sm);
        text-decoration: none;
        transition: all 0.3s ease;
    }

    .menu-link:hover {
        background: rgba(255,255,255,0.2);
        color: white;
    }

    .menu-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.5);
        z-index: 999;
        display: none;
    }

    .menu-overlay.show {
        display: block;
    }

    /* تحسينات إضافية للموبايل */
    .fab-menu {
        position: fixed;
        bottom: 100px;
        left: 1rem;
        z-index: 100;
    }

    .fab-btn {
        width: 56px;
        height: 56px;
        background: var(--accent-gradient);
        border: none;
        border-radius: 50%;
        color: white;
        font-size: 1.3rem;
        box-shadow: var(--box-shadow);
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .fab-btn:hover {
        transform: scale(1.1);
    }

    /* تصميم responsive للشاشات الصغيرة جداً */
    @media (max-width: 360px) {
        .stats-grid-mobile {
            grid-template-columns: 1fr;
        }
        
        .student-stats-mobile {
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
        }
        
        .stat-item-mobile {
            padding: 0.75rem 0.5rem;
        }
        
        .mobile-header {
            padding: 0.75rem 0.75rem 1.5rem;
        }
        
        .header-title h1 {
            font-size: 1.1rem;
        }
    }

    /* تحسينات للأجهزة ذات الدقة العالية */
    @media (-webkit-min-device-pixel-ratio: 2) {
        .stat-card-mobile,
        .student-card-mobile,
        .chart-container-mobile {
            box-shadow: 0 8px 32px rgba(99, 102, 241, 0.12);
        }
    }

    /* تحسين للموضوع الليلي (إذا كان مطلوباً) */
    @media (prefers-color-scheme: dark) {
        :root {
            --surface-color: #1a1a1a;
            --background-color: #0f0f0f;
            --text-primary: #ffffff;
            --text-secondary: #a0a0a0;
        }
    }

    /* تحسينات الاستجابة للاتجاه */
    @media (orientation: landscape) and (max-height: 600px) {
        .mobile-header {
            padding: 0.5rem 1rem 1rem;
        }
        
        .stats-grid-mobile {
            grid-template-columns: repeat(4, 1fr);
        }
        
        .chart-canvas-mobile {
            height: 200px;
        }
    }

    /* إضافات للوصول الشامل */
    .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0;
    }

    /* تحسينات الأداء */
    .student-card-mobile,
    .stat-card-mobile,
    .chart-container-mobile {
        will-change: transform;
    }

    /* مؤثرات الانتقال السلس */
    .fade-in {
        animation: fadeInUp 0.6s ease-out;
    }

    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .slide-in {
        animation: slideInRight 0.4s ease-out;
    }

    @keyframes slideInRight {
        from {
            opacity: 0;
            transform: translateX(30px);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }
    </style>
</head>
<body>
    <!-- الهيدر المتقدم -->
    <header class="mobile-header">
        <div class="header-top">
            <button class="back-btn" onclick="history.back()">
                <i class="fas fa-arrow-right"></i>
            </button>
            <div class="header-title">
                <h1>تقرير الحضور</h1>
                <small>{{ classroom.name }} - {{ classroom.subject }}</small>
            </div>
            <button class="menu-btn" onclick="toggleMenu()">
                <i class="fas fa-bars"></i>
            </button>
        </div>
        <div class="header-filters">
            <select class="filter-select-mobile" id="dateRangeFilter" onchange="filterByDateRange()">
                <option value="all">كامل الفترة</option>
                <option value="week">آخر أسبوع</option>
                <option value="month">آخر شهر</option>
                <option value="quarter">آخر ربع</option>
            </select>
            <select class="filter-select-mobile" id="statusFilter" onchange="filterByStatus()">
                <option value="all">جميع الحالات</option>
                <option value="present">حاضر</option>
                <option value="late">متأخر</option>
                <option value="absent">غائب</option>
            </select>
        </div>
    </header>

    <!-- المحتوى الرئيسي -->
    <div class="mobile-content">
        <!-- بطاقات الإحصائيات -->
        <div class="stats-grid-mobile fade-in">
            <div class="stat-card-mobile">
                <div class="stat-icon-mobile">
                    <i class="fas fa-users"></i>
                </div>
                <div class="stat-number-mobile">{{ students_data|length }}</div>
                <div class="stat-label-mobile">إجمالي الطلاب</div>
            </div>

            <div class="stat-card-mobile">
                <div class="stat-icon-mobile">
                    <i class="fas fa-check-circle"></i>
                </div>
                {% set present_avg = students_data|map(attribute='attendance_stats.attendance_rate')|sum / students_data|length if students_data else 0 %}
                <div class="stat-number-mobile">{{ "%.0f"|format(present_avg) }}%</div>
                <div class="stat-label-mobile">متوسط الحضور</div>
            </div>

            <div class="stat-card-mobile">
                <div class="stat-icon-mobile">
                    <i class="fas fa-calendar-check"></i>
                </div>
                {% set total_present = students_data|map(attribute='attendance_stats.present_days')|sum %}
                <div class="stat-number-mobile">{{ total_present }}</div>
                <div class="stat-label-mobile">أيام الحضور</div>
            </div>

            <div class="stat-card-mobile">
                <div class="stat-icon-mobile">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                {% set total_absent = students_data|map(attribute='attendance_stats.absent_days')|sum %}
                <div class="stat-number-mobile">{{ total_absent }}</div>
                <div class="stat-label-mobile">أيام الغياب</div>
            </div>
        </div>

        <!-- الرسوم البيانية -->
        <div class="charts-mobile fade-in">
            <div class="chart-container-mobile">
                <h3 class="chart-title-mobile">توزيع حالات الحضور</h3>
                <canvas id="distributionChartMobile" class="chart-canvas-mobile"></canvas>
            </div>

            <div class="chart-container-mobile">
                <h3 class="chart-title-mobile">اتجاه الحضور</h3>
                <canvas id="trendChartMobile" class="chart-canvas-mobile"></canvas>
            </div>
        </div>

        <!-- قسم الطلاب -->
        <div class="students-section-mobile">
            <div class="section-header-mobile">
                <h2 class="section-title-mobile">قائمة الطلاب</h2>
                <div class="view-toggle-mobile">
                    <button class="view-btn-mobile active" onclick="switchView('cards')">
                        <i class="fas fa-th-large"></i>
                    </button>
                    <button class="view-btn-mobile" onclick="switchView('table')">
                        <i class="fas fa-table"></i>
                    </button>
                </div>
            </div>

            <!-- عرض البطاقات -->
            <div class="students-grid-mobile" id="cardsView">
                {% for data in students_data %}
                {% set student = data.student %}
                {% set stats = data.attendance_stats %}
                <div class="student-card-mobile slide-in">
                    <div class="student-header-mobile">
                        {% if student.profile_picture %}
                        <img src="{{ url_for('static', filename='uploads/profile_pictures/' + student.profile_picture) }}" 
                             class="student-avatar-mobile" alt="{{ student.name }}">
                        {% else %}
                        <div class="student-placeholder-mobile">
                            <i class="fas fa-user"></i>
                        </div>
                        {% endif %}
                        <div class="student-info-mobile">
                            <h5>{{ student.name }}</h5>
                            <small>{{ student.email or 'غير محدد' }}</small>
                        </div>
                    </div>

                    <div class="student-stats-mobile">
                        <div class="stat-item-mobile present">
                            <span class="stat-value-mobile">{{ stats.present_days or 0 }}</span>
                            <small>حاضر</small>
                        </div>
                        <div class="stat-item-mobile late">
                            <span class="stat-value-mobile">{{ stats.late_days or 0 }}</span>
                            <small>متأخر</small>
                        </div>
                        <div class="stat-item-mobile absent">
                            <span class="stat-value-mobile">{{ stats.absent_days or 0 }}</span>
                            <small>غائب</small>
                        </div>
                        <div class="stat-item-mobile rate">
                            <span class="stat-value-mobile">{{ stats.attendance_rate or 0 }}%</span>
                            <small>النسبة</small>
                        </div>
                    </div>

                    <div class="student-actions-mobile">
                        <button onclick="viewStudentDetails({{ student.id }})" class="action-btn-mobile btn-view-mobile">
                            <i class="fas fa-eye"></i>
                            <span>التفاصيل</span>
                        </button>
                        <button onclick="contactStudent({{ student.id }})" class="action-btn-mobile btn-contact-mobile">
                            <i class="fas fa-phone"></i>
                            <span>اتصال</span>
                        </button>
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- عرض الجدول -->
            <div class="table-view-mobile" id="tableView">
                <table class="table-mobile">
                    <thead>
                        <tr>
                            <th>الطالب</th>
                            <th>الحضور</th>
                            <th>الغياب</th>
                            <th>النسبة</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for data in students_data %}
                        {% set student = data.student %}
                        {% set stats = data.attendance_stats %}
                        <tr>
                            <td>
                                <div style="text-align: right;">
                                    <strong>{{ student.name }}</strong><br>
                                    <small class="text-muted">{{ student.email or 'غير محدد' }}</small>
                                </div>
                            </td>
                            <td><span style="color: var(--success-color); font-weight: bold;">{{ stats.present_days or 0 }}</span></td>
                            <td><span style="color: var(--danger-color); font-weight: bold;">{{ stats.absent_days or 0 }}</span></td>
                            <td><span style="color: var(--accent-color); font-weight: bold;">{{ stats.attendance_rate or 0 }}%</span></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- مساحة للأزرار السفلية -->
        <div style="height: 100px;"></div>
    </div>

    <!-- الأزرار السفلية -->
    <div class="bottom-actions-mobile">
        <a href="/attendance/mark/{{ classroom.id }}" class="btn-mobile btn-primary-mobile">
            <i class="fas fa-plus-circle"></i>
            <span>تسجيل حضور</span>
        </a>
        <button onclick="exportReport()" class="btn-mobile btn-secondary-mobile">
            <i class="fas fa-download"></i>
            <span>تصدير</span>
        </button>
    </div>

    <!-- زر العمل العائم -->
    <div class="fab-menu">
        <button class="fab-btn" onclick="scrollToTop()">
            <i class="fas fa-arrow-up"></i>
        </button>
    </div>

    <!-- القائمة الجانبية -->
    <div class="mobile-menu" id="mobileMenu">
        <div class="menu-header">
            <div class="menu-logo">
                <i class="fas fa-chart-line"></i>
            </div>
            <h3>تقرير الحضور</h3>
        </div>
        <ul class="menu-items">
            <li class="menu-item">
                <a href="#" class="menu-link" onclick="scrollToSection('stats')">
                    <i class="fas fa-chart-pie"></i>
                    <span>الإحصائيات</span>
                </a>
            </li>
            <li class="menu-item">
                <a href="#" class="menu-link" onclick="scrollToSection('charts')">
                    <i class="fas fa-chart-bar"></i>
                    <span>الرسوم البيانية</span>
                </a>
            </li>
            <li class="menu-item">
                <a href="#" class="menu-link" onclick="scrollToSection('students')">
                    <i class="fas fa-users"></i>
                    <span>قائمة الطلاب</span>
                </a>
            </li>
            <li class="menu-item">
                <a href="#" class="menu-link" onclick="exportReport()">
                    <i class="fas fa-download"></i>
                    <span>تصدير التقرير</span>
                </a>
            </li>
            <li class="menu-item">
                <a href="javascript:history.back()" class="menu-link">
                    <i class="fas fa-arrow-right"></i>
                    <span>العودة</span>
                </a>
            </li>
        </ul>
    </div>

    <!-- طبقة التراكب -->
    <div class="menu-overlay" id="menuOverlay" onclick="toggleMenu()"></div>

    <!-- نافذة تفاصيل الطالب -->
    <div class="modal fade" id="studentDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-fullscreen">
            <div class="modal-content">
                <div class="modal-header" style="background: var(--accent-gradient); color: white;">
                    <h5 class="modal-title">
                        <i class="fas fa-user-graduate me-2"></i>
                        تفاصيل الطالب
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="studentDetailsContent" style="padding: 1rem;">
                    <!-- سيتم تحميل المحتوى هنا -->
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.min.js"></script>

    <script>
    // بيانات الرسوم البيانية
    const attendanceData = {
        distribution: {{ stats.distribution_data|tojson if stats else '{}' }},
        trend: {{ stats.trend_data|tojson if stats else '{}' }}
    };

    // تهيئة الرسوم البيانية للموبايل
    function setupMobileCharts() {
        // الرسم البياني الدائري
        const distributionCtx = document.getElementById('distributionChartMobile').getContext('2d');
        new Chart(distributionCtx, {
            type: 'doughnut',
            data: {
                labels: ['حاضر', 'متأخر', 'غائب', 'معذور'],
                datasets: [{
                    data: [
                        attendanceData.distribution.present || 0,
                        attendanceData.distribution.late || 0,
                        attendanceData.distribution.absent || 0,
                        attendanceData.distribution.excused || 0
                    ],
                    backgroundColor: [
                        '#10b981',
                        '#f59e0b',
                        '#ef4444',
                        '#6366f1'
                    ],
                    borderWidth: 0,
                    cutout: '70%'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            font: {
                                family: 'Tajawal',
                                size: 12
                            },
                            padding: 15,
                            usePointStyle: true
                        }
                    }
                }
            }
        });

        // الرسم البياني الخطي
        const trendCtx = document.getElementById('trendChartMobile').getContext('2d');
        new Chart(trendCtx, {
            type: 'line',
            data: {
                labels: attendanceData.trend.dates || [],
                datasets: [{
                    label: 'نسبة الحضور',
                    data: attendanceData.trend.rates || [],
                    borderColor: '#6366f1',
                    backgroundColor: 'rgba(99, 102, 241, 0.1)',
                    fill: true,
                    tension: 0.4,
                    borderWidth: 2,
                    pointBackgroundColor: '#6366f1',
                    pointBorderColor: '#ffffff',
                    pointBorderWidth: 2,
                    pointRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        grid: {
                            color: 'rgba(0,0,0,0.1)'
                        },
                        ticks: {
                            font: {
                                family: 'Tajawal',
                                size: 10
                            },
                            callback: function(value) {
                                return value + '%';
                            }
                        }
                    },
                    x: {
                        grid: {
                            color: 'rgba(0,0,0,0.1)'
                        },
                        ticks: {
                            font: {
                                family: 'Tajawal',
                                size: 10
                            },
                            maxTicksLimit: 5
                        }
                    }
                }
            }
        });
    }

    // تبديل القائمة
    function toggleMenu() {
        const menu = document.getElementById('mobileMenu');
        const overlay = document.getElementById('menuOverlay');
        
        menu.classList.toggle('show');
        overlay.classList.toggle('show');
    }

    // تبديل طريقة العرض
    function switchView(viewType) {
        const cardsView = document.getElementById('cardsView');
        const tableView = document.getElementById('tableView');
        const buttons = document.querySelectorAll('.view-btn-mobile');
        
        // إزالة الفئة النشطة من جميع الأزرار
        buttons.forEach(btn => btn.classList.remove('active'));
        
        if (viewType === 'cards') {
            cardsView.style.display = 'grid';
            tableView.classList.remove('active');
            buttons[0].classList.add('active');
        } else {
            cardsView.style.display = 'none';
            tableView.classList.add('active');
            buttons[1].classList.add('active');
        }
    }

    // التمرير إلى الأعلى
    function scrollToTop() {
        window.scrollTo({
            top: 0,
            behavior: 'smooth'
        });
    }

    // التمرير إلى قسم معين
    function scrollToSection(section) {
        let element;
        switch(section) {
            case 'stats':
                element = document.querySelector('.stats-grid-mobile');
                break;
            case 'charts':
                element = document.querySelector('.charts-mobile');
                break;
            case 'students':
                element = document.querySelector('.students-section-mobile');
                break;
        }
        
        if (element) {
            element.scrollIntoView({
                behavior: 'smooth',
                block: 'start'
            });
        }
        
        toggleMenu(); // إغلاق القائمة بعد التنقل
    }

    // تصفية حسب النطاق الزمني
    function filterByDateRange() {
        const range = document.getElementById('dateRangeFilter').value;
        console.log('Filter by date range:', range);
        // إضافة منطق الفلترة
    }

    // تصفية حسب الحالة
    function filterByStatus() {
        const status = document.getElementById('statusFilter').value;
        const cards = document.querySelectorAll('.student-card-mobile');
        
        cards.forEach(card => {
            if (status === 'all') {
                card.style.display = 'block';
            } else {
                // إضافة منطق التصفية المطلوب
                card.style.display = 'block';
            }
        });
    }

    // عرض تفاصيل الطالب
    function viewStudentDetails(studentId) {
        fetch(`/attendance/student-details/${studentId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const student = data.student;
                const stats = data.stats;
                
                const content = `
                    <div class="text-center mb-4">
                        ${student.profile_picture ? 
                            `<img src="/static/uploads/profile_pictures/${student.profile_picture}" 
                                 class="rounded-circle mb-3" style="width: 100px; height: 100px; object-fit: cover;">` :
                            `<div class="bg-primary rounded-circle d-inline-flex align-items-center justify-content-center mb-3" 
                                 style="width: 100px; height: 100px; font-size: 2.5rem; color: white;">
                                <i class="fas fa-user"></i>
                             </div>`
                        }
                        <h4>${student.name}</h4>
                        <p class="text-muted">${student.email || 'لا يوجد بريد إلكتروني'}</p>
                    </div>

                    <div class="row mb-3">
                        <div class="col-6">
                            <div class="card text-center border-success">
                                <div class="card-body py-2">
                                    <h5 class="text-success mb-1">${stats.present_days || 0}</h5>
                                    <small>أيام الحضور</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="card text-center border-danger">
                                <div class="card-body py-2">
                                    <h5 class="text-danger mb-1">${stats.absent_days || 0}</h5>
                                    <small>أيام الغياب</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-6">
                            <div class="card text-center border-warning">
                                <div class="card-body py-2">
                                    <h5 class="text-warning mb-1">${stats.late_days || 0}</h5>
                                    <small>أيام التأخير</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="card text-center border-primary">
                                <div class="card-body py-2">
                                    <h5 class="text-primary mb-1">${stats.attendance_rate || 0}%</h5>
                                    <small>نسبة الحضور</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <h6 class="text-primary mb-2">
                            <i class="fas fa-phone me-2"></i>معلومات الاتصال
                        </h6>
                        <div class="d-grid gap-2">
                            ${student.phone ? 
                                `<a href="tel:${student.phone}" class="btn btn-outline-primary btn-sm">
                                    <i class="fas fa-phone me-1"></i>
                                    اتصال بالطالب
                                </a>` : ''
                            }
                            ${student.phone ? 
                                `<a href="https://wa.me/2${student.phone}" target="_blank" class="btn btn-outline-success btn-sm">
                                    <i class="fab fa-whatsapp me-1"></i>
                                    واتساب الطالب
                                </a>` : ''
                            }
                            ${(student.alt_phone || student.parent_phone) ? 
                                `<a href="tel:${student.alt_phone || student.parent_phone}" class="btn btn-outline-info btn-sm">
                                    <i class="fas fa-phone me-1"></i>
                                    اتصال بولي الأمر
                                </a>` : ''
                            }
                            ${(student.alt_phone || student.parent_phone) ? 
                                `<a href="https://wa.me/2${student.alt_phone || student.parent_phone}" target="_blank" class="btn btn-outline-success btn-sm">
                                    <i class="fab fa-whatsapp me-1"></i>
                                    واتساب ولي الأمر
                                </a>` : ''
                            }
                        </div>
                    </div>
                `;
                
                document.getElementById('studentDetailsContent').innerHTML = content;
                new bootstrap.Modal(document.getElementById('studentDetailsModal')).show();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('حدث خطأ في جلب بيانات الطالب');
        });
    }

    // التواصل مع الطالب
    function contactStudent(studentId) {
        console.log('Contact student:', studentId);
    }

    // تصدير التقرير
    function exportReport() {
        // إنشاء قائمة خيارات التصدير
        const options = [
            { text: 'تصدير PDF', action: 'pdf' },
            { text: 'تصدير Excel', action: 'excel' },
            { text: 'طباعة التقرير', action: 'print' }
        ];
        
        const actionSheet = document.createElement('div');
        actionSheet.innerHTML = `
            <div class="modal fade" id="exportModal" tabindex="-1">
                <div class="modal-dialog modal-dialog-bottom">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">تصدير التقرير</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="d-grid gap-2">
                                <button class="btn btn-outline-danger" onclick="exportToPDF()">
                                    <i class="fas fa-file-pdf me-2"></i>تصدير PDF
                                </button>
                                <button class="btn btn-outline-success" onclick="exportToExcel()">
                                    <i class="fas fa-file-excel me-2"></i>تصدير Excel
                                </button>
                                <button class="btn btn-outline-secondary" onclick="printReport()">
                                    <i class="fas fa-print me-2"></i>طباعة التقرير
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(actionSheet);
        new bootstrap.Modal(document.getElementById('exportModal')).show();
    }

    function exportToPDF() {
        console.log('Export to PDF');
        bootstrap.Modal.getInstance(document.getElementById('exportModal')).hide();
    }

    function exportToExcel() {
        console.log('Export to Excel');
        bootstrap.Modal.getInstance(document.getElementById('exportModal')).hide();
    }

    function printReport() {
        window.print();
        bootstrap.Modal.getInstance(document.getElementById('exportModal')).hide();
    }

    // تهيئة الصفحة
    document.addEventListener('DOMContentLoaded', function() {
        setupMobileCharts();
        
        // إضافة مؤثرات الانتقال للعناصر
        const cards = document.querySelectorAll('.student-card-mobile');
        cards.forEach((card, index) => {
            card.style.animationDelay = `${index * 0.1}s`;
        });

        // تحسين الأداء
        if ('serviceWorker' in navigator) {
            // يمكن إضافة service worker للتحميل السريع
        }

        // إضافة مستمعات الأحداث للمس
        let startY = 0;
        let endY = 0;

        document.addEventListener('touchstart', function(e) {
            startY = e.touches[0].clientY;
        });

        document.addEventListener('touchend', function(e) {
            endY = e.changedTouches[0].clientY;
            const diff = startY - endY;
            
            // التمرير السريع للأعلى لإظهار زر العودة للأعلى
            if (diff > 100) {
                document.querySelector('.fab-btn').style.display = 'flex';
            }
        });

        // إخفاء زر العودة للأعلى عند الوصول للأعلى
        window.addEventListener('scroll', function() {
            const fabBtn = document.querySelector('.fab-btn');
            if (window.pageYOffset > 300) {
                fabBtn.style.display = 'flex';
            } else {
                fabBtn.style.display = 'none';
            }
        });
    });

    // إضافة دعم للإيماءات
    let touchStartX = 0;
    let touchStartY = 0;

    document.addEventListener('touchstart', function(e) {
        touchStartX = e.touches[0].clientX;
        touchStartY = e.touches[0].clientY;
    }, { passive: true });

    document.addEventListener('touchmove', function(e) {
        if (!touchStartX || !touchStartY) {
            return;
        }

        let touchEndX = e.touches[0].clientX;
        let touchEndY = e.touches[0].clientY;

        let diffX = touchStartX - touchEndX;
        let diffY = touchStartY - touchEndY;

        // السحب من اليسار لفتح القائمة
        if (Math.abs(diffX) > Math.abs(diffY)) {
            if (diffX < -50 && touchStartX < 50) {
                toggleMenu();
            }
        }

        touchStartX = 0;
        touchStartY = 0;
    }, { passive: true });
    </script>
</body>
</html>

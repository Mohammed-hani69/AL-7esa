<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>إدارة المستخدمين - الحصة</title>
    
    <!-- الخطوط وملفات CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.rtl.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/admin/users.css') }}">

    <style>
    /* متغيرات التصميم المخصص */
    :root {
        --accent-color: {{ primary_color }};
        --accent-gradient: linear-gradient(120deg, {{ primary_color }}, {{ secondary_color }});
        --surface-color: #FFFFFF;
        --background-color: #F4F7FE;
        --text-primary: #2D3748;
        --text-secondary: #718096;
        --border-radius-lg: 24px;
        --border-radius-md: 16px;
        --border-radius-sm: 8px;
        --box-shadow: 0 10px 30px -5px rgba(108, 99, 255, 0.1);
    }

    /* تنسيق عام */
    body {
        font-family: 'Tajawal', sans-serif;
        background: var(--background-color);
        margin: 0;
        padding: 0;
        min-height: 100vh;
    }

    /* تخطيط الصفحة */
    .app-container {
        display: grid;
        grid-template-columns: 300px 1fr;
        gap: 2rem;
        min-height: 100vh;
        padding: 2rem;
    }

    /* تصميم السايدبار */
    .innovative-sidebar {
        background: var(--accent-gradient);
        padding: 2rem;
        border-radius: var(--border-radius-lg);
        box-shadow: var(--box-shadow);
        position: sticky;
        top: 2rem;
        height: calc(100vh - 4rem);
        color: var(--surface-color);
    }

    .sidebar-brand {
        text-align: center;
        margin-bottom: 3rem;
    }

    .brand-logo {
        width: 60px;
        height: 60px;
        background: var(--surface-color);
        border-radius: var(--border-radius-md);
        padding: 10px;
        margin-bottom: 1rem;
    }

    .brand-text {
        color: var(--surface-color);
        font-size: 1.5rem;
        font-weight: 700;
        margin: 0;
    }

    .nav-menu {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .nav-item {
        margin-bottom: 1rem;
    }

    .nav-link {
        display: flex;
        align-items: center;
        color: rgba(255,255,255,0.8);
        padding: 1rem;
        border-radius: var(--border-radius-md);
        transition: all 0.3s ease;
        text-decoration: none;
    }

    .nav-link:hover, .nav-link.active {
        background: rgba(255,255,255,0.1);
        color: var(--surface-color);
        transform: translateX(-10px);
    }

    .nav-link i {
        margin-left: 1rem;
        font-size: 1.2rem;
        width: 24px;
        text-align: center;
    }

    /* تصميم المحتوى الرئيسي */
    .main-content {
        flex: 1;
    }

    /* تصميم الهيدر */
    .page-header {
        background: var(--surface-color);
        border-radius: var(--border-radius-lg);
        padding: 1.5rem 2rem;
        margin-bottom: 2rem;
        box-shadow: var(--box-shadow);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .page-title {
        font-size: 1.8rem;
        color: var(--text-primary);
        margin: 0;
        position: relative;
    }

    .page-title::after {
        content: '';
        position: absolute;
        bottom: -10px;
        right: 0;
        width: 50px;
        height: 4px;
        background: var(--accent-gradient);
        border-radius: 2px;
    }

    /* تصميم البطاقات الإحصائية */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .stat-card {
        background: var(--surface-color);
        border-radius: var(--border-radius-md);
        padding: 1.5rem;
        box-shadow: var(--box-shadow);
        transition: all 0.3s ease;
        border: none;
        position: relative;
        overflow: hidden;
    }

    .stat-card:hover {
        transform: translateY(-5px);
    }

    .stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        right: 0;
        width: 4px;
        height: 100%;
        background: var(--accent-gradient);
        border-radius: 2px;
    }

    .stat-icon {
        width: 48px;
        height: 48px;
        border-radius: var(--border-radius-sm);
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 1rem;
        background: var(--accent-gradient);
        color: var(--surface-color);
    }

    .stat-title {
        color: var(--text-secondary);
        font-size: 0.9rem;
        margin-bottom: 0.5rem;
    }

    .stat-value {
        color: var(--text-primary);
        font-size: 1.5rem;
        font-weight: 700;
    }

    /* تصميم جدول المستخدمين وفلاتر البحث */
    .users-filter-card, .users-table-card {
        background: var(--surface-color);
        border-radius: var(--border-radius-lg);
        box-shadow: var(--box-shadow);
        border: none;
        margin-bottom: 2rem;
    }

    .users-filter-header, .users-table-header {
        padding: 1.5rem 2rem;
        border-bottom: 2px solid var(--background-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .users-table-title {
        font-size: 1.2rem;
        color: var(--text-primary);
        margin: 0;
        font-weight: 600;
    }

    .form-control {
        border: 2px solid #E2E8F0;
        border-radius: var(--border-radius-sm);
        padding: 0.75rem 1rem;
        transition: all 0.3s ease;
    }

    .form-control:focus {
        border-color: var(--accent-color);
        box-shadow: 0 0 0 3px rgba(108, 99, 255, 0.1);
    }

    .search-form {
        position: relative;
    }

    .search-form .search-icon {
        position: absolute;
        left: 1rem;
        top: 50%;
        transform: translateY(-50%);
        color: var(--text-secondary);
    }

    /* تصميم الأزرار */
    .btn-custom {
        padding: 0.8rem 1.5rem;
        border-radius: var(--border-radius-sm);
        font-weight: 500;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }

    .btn-primary {
        background: var(--accent-gradient);
        border: none;
        color: white;
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(108, 99, 255, 0.3);
    }

    /* تصميم الجدول */
    .users-table {
        width: 100%;
        margin: 0;
    }

    .users-table th {
        background: var(--background-color);
        color: var(--text-primary);
        font-weight: 600;
        padding: 1rem 2rem;
        border: none;
    }

    .users-table td {
        padding: 1rem 2rem;
        color: var(--text-secondary);
        border-bottom: 1px solid var(--background-color);
        vertical-align: middle;
    }

    /* تصميم الشارات */
    .role-badge, .status-badge {
        padding: 0.5rem 1rem;
        border-radius: 50px;
        font-size: 0.875rem;
        font-weight: 500;
    }

    .role-student {
        background: linear-gradient(120deg, #00B5B5, #00D68F);
        color: white;
    }

    .role-teacher {
        background: linear-gradient(120deg, #6C63FF, #8B5CF6);
        color: white;
    }

    .role-assistant {
        background: linear-gradient(120deg, #F59E0B, #FFA600);
        color: white;
    }

    .role-admin {
        background: linear-gradient(120deg, #EF4444, #DC2626);
        color: white;
    }

    .status-active {
        background: linear-gradient(120deg, #00B5B5, #00D68F);
        color: white;
    }

    .status-inactive {
        background: linear-gradient(120deg, #9CA3AF, #6B7280);
        color: white;
    }

    /* تصميم النوافذ المنبثقة */
    .modal-content {
        border: none;
        border-radius: var(--border-radius-lg);
        overflow: hidden;
    }

    .modal-header {
        background: var(--accent-gradient);
        color: white;
        border-bottom: none;
        padding: 1.5rem 2rem;
    }

    .modal-title {
        font-size: 1.25rem;
        font-weight: 600;
    }

    .modal-body {
        padding: 2rem;
    }

    /* تحسينات التجاوب */
    @media (max-width: 1200px) {
        .app-container {
            grid-template-columns: 250px 1fr;
            padding: 1rem;
        }
    }

    @media (max-width: 992px) {
        .app-container {
            grid-template-columns: 1fr;
        }
        
        .innovative-sidebar {
            position: fixed;
            right: -300px;
            z-index: 1000;
            transition: 0.3s ease;
            height: 100vh;
            border-radius: 0;
        }
        
        .innovative-sidebar.show {
            right: 0;
        }
        
        .mobile-toggle {
            display: block;
            position: fixed;
            right: 1rem;
            top: 1rem;
            z-index: 1001;
            background: var(--surface-color);
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            box-shadow: var(--box-shadow);
        }
    }

    @media (max-width: 768px) {
        .stats-grid {
            grid-template-columns: 1fr;
        }
        .users-table-header {
            flex-direction: column;
            gap: 1rem;
        }
    }

    @media (max-width: 576px) {
        .innovative-sidebar {
            display: none;
        }

        .mobile-header {
            position: fixed;
            top: 0;
            right: 0;
            left: 0;
            z-index: 1000;
            background: var(--accent-gradient);
            padding: 0.75rem;
            box-shadow: 0 2px 15px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .mobile-header-brand {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: white;
            text-decoration: none;
        }

        .mobile-header-logo {
            width: 35px;
            height: 35px;
            border-radius: 8px;
            background: white;
            padding: 5px;
        }

        .mobile-header-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin: 0;
        }

        .mobile-nav {
            position: fixed;
            top: 60px;
            right: 0;
            left: 0;
            background: white;
            padding: 0.5rem;
            box-shadow: 0 2px 15px rgba(0, 0, 0, 0.1);
            transform: translateY(-100%);
            transition: transform 0.3s ease;
            z-index: 999;
        }

        .mobile-nav.show {
            transform: translateY(0);
        }

        .mobile-nav-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .mobile-nav-item {
            margin: 0;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        .mobile-nav-item:last-child {
            border-bottom: none;
        }

        .mobile-nav-link {
            display: flex;
            align-items: center;
            padding: 0.75rem;
            color: var(--text-primary);
            text-decoration: none;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .mobile-nav-link i {
            width: 24px;
            margin-left: 0.75rem;
            font-size: 1.1rem;
            color: var(--accent-color);
        }

        .mobile-nav-link.active {
            background: var(--accent-gradient);
            color: white;
            border-radius: 8px;
        }

        .mobile-nav-link.active i {
            color: white;
        }

        .mobile-toggle {
            width: 35px;
            height: 35px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 0;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.1);
        }

        .main-content {
            margin-top: 70px;
            padding: 0.75rem;
        }

        .page-header {
            background: white;
            border-radius: 12px;
            padding: 1rem;
            margin: 0 0 1rem 0;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .page-title {
            font-size: 1.3rem;
            text-align: center;
            margin-bottom: 1rem;
        }

        .page-title::after {
            right: 50%;
            transform: translateX(50%);
            width: 40px;
        }

        .stats-grid {
            grid-template-columns: 1fr;
            gap: 0.75rem;
            margin: 0.75rem 0;
        }

        .stat-card {
            padding: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .stat-icon {
            width: 40px;
            height: 40px;
            margin: 0;
        }

        .stat-info {
            flex: 1;
        }

        .users-filter-card, .users-table-card {
            margin: 0.75rem 0;
            border-radius: 12px;
        }

        .card-header {
            padding: 1rem;
            flex-direction: column;
            gap: 0.75rem;
        }

        .btn-group {
            width: 100%;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .btn-group .btn {
            flex: 1;
        }
    }

    /* تصميم إضافي للجدول */
    .action-btn {
        width: 32px;
        height: 32px;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: var(--border-radius-sm);
        background: var(--background-color);
        color: var(--text-secondary);
        border: none;
        transition: all 0.3s ease;
    }

    .action-btn:hover {
        background: var(--accent-color);
        color: white;
        transform: translateY(-2px);
    }

    /* تصميم الصفحات */
    .pagination {
        display: flex;
        justify-content: center;
        gap: 0.5rem;
        margin-top: 2rem;
    }

    .page-link {
        border: none;
        padding: 0.5rem 1rem;
        border-radius: var(--border-radius-sm);
        color: var(--text-primary);
        background: var(--surface-color);
        box-shadow: var(--box-shadow);
        transition: all 0.3s ease;
    }

    .page-link:hover {
        background: var(--accent-color);
        color: white;
        transform: translateY(-2px);
    }

    .page-item.active .page-link {
        background: var(--accent-gradient);
        color: white;
    }

    /* تنسيقات إضافية للنموذج */
    .form-group {
        margin-bottom: 1rem;
    }

    .form-label {
        color: var(--text-primary);
        margin-bottom: 0.5rem;
    }

    .form-label i {
        color: var(--accent-color);
        width: 20px;
        text-align: center;
    }

    .form-control, .form-select {
        border: 2px solid #E2E8F0;
        border-radius: var(--border-radius-sm);
        padding: 0.75rem 1rem;
        transition: all 0.3s ease;
    }

    .form-control:focus, .form-select:focus {
        border-color: var(--accent-color);
        box-shadow: 0 0 0 3px rgba(108, 99, 255, 0.1);
    }

    .input-group .btn {
        border: 2px solid #E2E8F0;
        border-right: none;
        background: var(--background-color);
    }

    .form-check-input {
        width: 3rem;
        height: 1.5rem;
        margin-left: 1rem;
    }

    .form-check-input:checked {
        background-color: var(--accent-color);
        border-color: var(--accent-color);
    }

    .form-check-label {
        color: var(--text-primary);
    }

    .text-primary {
        color: var(--accent-color) !important;
    }

    hr {
        margin: 2rem 0;
        border-color: #E2E8F0;
        opacity: 0.5;
    }

    /* تصميم DataTables */
    .dataTables_wrapper .dataTables_length {
        margin-bottom: 1rem;
    }

    .dataTables_wrapper .dataTables_length label {
        font-weight: 500;
        color: var(--text-primary);
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }

    .dataTables_wrapper .dataTables_length select {
        background-color: var(--surface-color);
        border: 2px solid #E2E8F0;
        border-radius: var(--border-radius-sm);
        padding: 0.4rem 1rem;
        margin: 0 0.5rem;
        font-weight: normal;
        color: var(--text-primary);
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .dataTables_wrapper .dataTables_length select:focus {
        border-color: var(--accent-color);
        box-shadow: 0 0 0 3px rgba(108, 99, 255, 0.1);
        outline: none;
    }

    .dataTables_wrapper .dataTables_filter {
        margin-bottom: 1rem;
    }

    .dataTables_wrapper .dataTables_filter label {
        font-weight: 500;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .dataTables_wrapper .dataTables_filter input {
        background-color: var(--surface-color);
        border: 2px solid #E2E8F0;
        border-radius: var(--border-radius-sm);
        padding: 0.4rem 1rem;
        margin-right: 0.5rem;
        color: var(--text-primary);
        transition: all 0.3s ease;
        width: 200px;
    }

    .dataTables_wrapper .dataTables_filter input:focus {
        border-color: var(--accent-color);
        box-shadow: 0 0 0 3px rgba(108, 99, 255, 0.1);
        outline: none;
    }

    .dataTables_wrapper .dataTables_info {
        color: var(--text-secondary);
        font-size: 0.9rem;
        margin-top: 1rem;
    }

    .dataTables_wrapper .dataTables_paginate {
        margin-top: 1rem;
    }

    /* تصميم أزرار التصدير */
    .dropdown-menu {
        border: 1px solid #E2E8F0;
        border-radius: var(--border-radius-sm);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        padding: 0.5rem 0;
        min-width: 280px;
    }

    .dropdown-item {
        padding: 0.75rem 1.5rem;
        transition: all 0.3s ease;
        border: none;
        background: none;
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        font-weight: 500;
        min-width: 250px;
    }

    .dropdown-item:hover {
        background-color: var(--background-color);
        color: var(--text-primary);
        transform: translateX(-3px);
    }

    .dropdown-item:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    .dropdown-item:disabled:hover {
        background: none;
        transform: none;
    }

    .dropdown-divider {
        margin: 0.5rem 1rem;
        border-color: #E2E8F0;
    }

    /* تصميم Toast الإشعارات */
    .toast {
        border-radius: var(--border-radius-sm);
        border: 1px solid #E2E8F0;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        min-width: 350px;
        max-width: 500px;
    }

    .toast-header {
        background-color: var(--surface-color);
        border-bottom: 1px solid #E2E8F0;
        padding: 0.75rem 1rem;
    }

    .toast-body {
        padding: 1rem;
        color: var(--text-primary);
        font-weight: 500;
        line-height: 1.4;
    }

    /* تصميم التوست المحدث */
    .toast {
        background: linear-gradient(45deg, #059669, #10B981);
        color: white;
        border-radius: 16px;
        box-shadow: 0 8px 25px rgba(5, 150, 105, 0.3);
        border: none;
    }

    .toast .toast-body {
        font-weight: 500;
        padding: 1rem;
        color: white;
    }

    .btn-close-white {
        filter: invert(1);
    }

    </style>
</head>
<body>
    <header class="mobile-header d-sm-none">
        <a href="{{ url_for('admin.dashboard') }}" class="mobile-header-brand">
            <img src="{{ url_for('static', filename='img/logo.svg') }}" alt="الحصة" class="mobile-header-logo" onerror="this.src='data:image/svg+xml;charset=utf-8,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 100 100\'%3E%3Crect width=\'100\' height=\'100\' fill=\'%23f0f0f0\'/%3E%3Ctext x=\'50\' y=\'50\' font-size=\'24\' fill=\'%23999\' text-anchor=\'middle\' dy=\'.3em\'%3ELogo%3C/text%3E%3C/svg%3E'">
            <h1 class="mobile-header-title">الحصة</h1>
        </a>
        <button class="mobile-toggle">
            <i class="fas fa-bars"></i>
        </button>
    </header>

    <nav class="mobile-nav d-sm-none">
        <ul class="mobile-nav-list">
            <li class="mobile-nav-item">
                <a href="{{ url_for('admin.dashboard') }}" class="mobile-nav-link {{ 'active' if request.endpoint == 'admin.dashboard' }}">
                    <i class="fas fa-chart-line"></i>
                    <span>لوحة التحكم</span>
                </a>
            </li>
            <li class="mobile-nav-item">
                <a href="{{ url_for('admin.users') }}" class="mobile-nav-link {{ 'active' if request.endpoint == 'admin.users' }}">
                    <i class="fas fa-users"></i>
                    <span>المستخدمين</span>
                </a>
            </li>
            <li class="mobile-nav-item">
                <a href="{{ url_for('admin.classrooms') }}" class="mobile-nav-link {{ 'active' if request.endpoint == 'admin.classrooms' }}">
                    <i class="fas fa-school"></i>
                    <span>الفصول الدراسية</span>
                </a>
            </li>
            <li class="mobile-nav-item">
                <a href="{{ url_for('admin.subscriptions') }}" class="mobile-nav-link {{ 'active' if request.endpoint == 'admin.subscriptions' }}">
                    <i class="fas fa-money-check"></i>
                    <span>الاشتراكات</span>
                </a>
            </li>
            <li class="mobile-nav-item">
                <a href="{{ url_for('admin.notifications') }}" class="mobile-nav-link {{ 'active' if request.endpoint == 'admin.notifications' }}">
                    <i class="fas fa-bell"></i>
                    <span>الإشعارات</span>
                </a>
            </li>
            <li class="mobile-nav-item">
                <a href="{{ url_for('admin.settings') }}" class="mobile-nav-link {{ 'active' if request.endpoint == 'admin.settings' }}">
                    <i class="fas fa-cog"></i>
                    <span>الإعدادات</span>
                </a>
            </li>
            <li class="mobile-nav-item">
                <a href="{{ url_for('teacher.dashboard') }}" class="mobile-nav-link {{ 'active' if request.endpoint == 'teacher.dashboard' }}">
                    <i class="fas fa-crown"></i>
                    <span>اشتراكاتي</span>
                </a>
            </li>
            
                <li class="nav-item">
                    <a href="{{ url_for('auth.logout') }}" class="nav-link">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>تسجيل خروج</span>
                    </a>
                </li>

        </ul>
    </nav>

    <button class="mobile-toggle d-lg-none">
        <i class="fas fa-bars"></i>
    </button>

    <div class="app-container">
        <!-- السايدبار -->
        <aside class="innovative-sidebar">
            <div class="sidebar-brand">
                <img src="{{ url_for('static', filename='img/logo.svg') }}" alt="الحصة" class="brand-logo" onerror="this.src='data:image/svg+xml;charset=utf-8,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 100 100\'%3E%3Crect width=\'100\' height=\'100\' fill=\'%23f0f0f0\'/%3E%3Ctext x=\'50\' y=\'50\' font-size=\'24\' fill=\'%23999\' text-anchor=\'middle\' dy=\'.3em\'%3ELogo%3C/text%3E%3C/svg%3E'">
                <h1 class="brand-text">الحصة</h1>
            </div>
            
            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="{{ url_for('admin.dashboard') }}" class="nav-link">
                        <i class="fas fa-chart-line"></i>
                        <span>لوحة التحكم</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="{{ url_for('admin.users') }}" class="nav-link active">
                        <i class="fas fa-users"></i>
                        <span>المستخدمين</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="{{ url_for('admin.classrooms') }}" class="nav-link ">
                        <i class="fas fa-school"></i>
                        <span>الفصول الدراسية</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="{{ url_for('admin.subscriptions') }}" class="nav-link">
                        <i class="fas fa-money-check"></i>
                        <span>الاشتراكات</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="{{ url_for('admin.notifications') }}" class="nav-link">
                        <i class="fas fa-bell"></i>
                        <span>الإشعارات</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="{{ url_for('admin.settings') }}" class="nav-link">
                        <i class="fas fa-cog"></i>
                        <span>الإعدادات</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="{{ url_for('teacher.dashboard') }}" class="nav-link">
                        <i class="fas fa-crown"></i>
                        <span>اشتراكاتي</span>
                    </a>
                </li>
            </ul>
        </aside>

        <!-- المحتوى الرئيسي -->
        <main class="main-content">
            <!-- هيدر الصفحة -->
            <header class="page-header">
                <h1 class="page-title">إدارة المستخدمين</h1>
                <button type="button" class="btn-custom btn-primary" data-bs-toggle="modal" data-bs-target="#addUserModal">
                    <i class="fas fa-user-plus"></i>
                    <span>إضافة مستخدم</span>
                </button>
            </header>

            <!-- البطاقات الإحصائية -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-users fa-lg"></i>
                    </div>
                    <div class="stat-title">إجمالي المستخدمين</div>
                    <div class="stat-value">{{ users.total }}</div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-user-graduate fa-lg"></i>
                    </div>
                    <div class="stat-title">الطلاب</div>
                    <div class="stat-value">{{ users.items|selectattr('role', 'equalto', 'student')|list|length }}</div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-chalkboard-teacher fa-lg"></i>
                    </div>
                    <div class="stat-title">المعلمين</div>
                    <div class="stat-value">{{ users.items|selectattr('role', 'equalto', 'teacher')|list|length }}</div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-user-shield fa-lg"></i>
                    </div>
                    <div class="stat-title">المشرفين</div>
                    <div class="stat-value">{{ users.items|selectattr('role', 'equalto', 'admin')|list|length }}</div>
                </div>
            </div>

            <!-- فلاتر البحث -->
            <div class="card shadow mb-4">
                <div class="card-header">
                    <h6 class="card-title">تصفية المستخدمين</h6>
                </div>
                <div class="card-body">
                    <form action="{{ url_for('admin.users') }}" method="get">
                        <div class="row g-3">
                            <div class="col-lg-3 col-md-6">
                                <label class="form-label">الصلاحية</label>
                                <select class="form-control" name="role">
                                    <option value="">الكل</option>
                                    <option value="student" {% if role == 'student' %}selected{% endif %}>طالب</option>
                                    <option value="teacher" {% if role == 'teacher' %}selected{% endif %}>معلم</option>
                                    <option value="assistant" {% if role == 'assistant' %}selected{% endif %}>مساعد</option>
                                    <option value="admin" {% if role == 'admin' %}selected{% endif %}>مسؤول</option>
                                </select>
                            </div>
                            <div class="col-lg-3 col-md-6">
                                <label class="form-label">الحالة</label>
                                <select class="form-control" name="status">
                                    <option value="">الكل</option>
                                    <option value="active" {% if status == 'active' %}selected{% endif %}>نشط</option>
                                    <option value="inactive" {% if status == 'inactive' %}selected{% endif %}>معطل</option>
                                </select>
                            </div>
                            <div class="col-lg-6">
                                <label class="form-label">بحث</label>
                                <div class="search-form">
                                    <input type="text" class="form-control" name="search" 
                                           placeholder="بحث بالاسم، البريد الإلكتروني، رقم الهاتف..."
                                           value="{{ search }}">
                                    <i class="fas fa-search search-icon"></i>
                                </div>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-lg-3 col-md-6">
                                <button type="submit" class="btn btn-primary w-100">
                                    <i class="fas fa-search me-2"></i>
                                    بحث
                                </button>
                            </div>
                            <div class="col-lg-3 col-md-6">
                                <a href="{{ url_for('admin.users') }}" class="btn btn-light w-100">
                                    <i class="fas fa-redo me-2"></i>
                                    إعادة تعيين
                                </a>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- جدول المستخدمين -->
            <div class="card shadow">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="card-title">قائمة المستخدمين ({{ users.total }})</h6>
                    <div class="btn-group">
                        <button class="btn btn-success btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-file-excel"></i> تصدير التقارير
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" id="exportUsersCSV" href="users/export/excel" >
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-file-csv text-primary me-2"></i>
                                    <div>
                                        <div>تصدير CSV</div>
                                        <small class="text-muted">ملف بسيط للبيانات الأساسية</small>
                                    </div>
                                </div>
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" id="exportUsersExcel" href="users/export/excel"  
                                   title="تقرير مفصل يحتوي على الملخص التنفيذي، بيانات المستخدمين التفصيلية، والرسوم البيانية التحليلية">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-file-excel text-success me-2"></i>
                                    <div>
                                        <div>تقرير Excel مفصل</div>
                                        <small class="text-muted">3 أوراق: ملخص + بيانات + تحليلات</small>
                                    </div>
                                </div>
                            </a></li>
                        </ul>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table users-table" id="usersTable">
                            <thead>
                                <tr>
                                    <th>المستخدم</th>
                                    <th>رقم الهاتف</th>
                                    <th>البريد الإلكتروني</th>
                                    <th>الصلاحية</th>
                                    <th>تاريخ التسجيل</th>
                                    <th>الحالة</th>
                                    <th>الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for user in users.items %}
                                <tr>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="ms-3">
                                                <h6 class="mb-0">{{ user.name }}</h6>
                                            </div>
                                        </div>
                                    </td>
                                    <td>{{ user.phone }}</td>
                                    <td>{{ user.email or '-' }}</td>
                                    <td>
                                        {% if user.role == 'student' %}
                                        <span class="role-badge role-student">طالب</span>
                                        {% elif user.role == 'teacher' %}
                                        <span class="role-badge role-teacher">معلم</span>
                                        {% elif user.role == 'assistant' %}
                                        <span class="role-badge role-assistant">مساعد</span>
                                        {% elif user.role == 'admin' %}
                                        <span class="role-badge role-admin">مسؤول</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ user.created_at.strftime('%Y-%m-%d') }}</td>
                                    <td>
                                        {% if user.is_active %}
                                        <span class="status-badge status-active">نشط</span>
                                        {% else %}
                                        <span class="status-badge status-inactive">معطل</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <form action="{{ url_for('admin.toggle_user_status', user_id=user.id) }}" method="POST" style="display: inline;" class="status-toggle-form">
                                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                            <button type="button" 
                                                    class="btn btn-sm toggle-user-status {% if user.is_active %}btn-warning{% else %}btn-success{% endif %}"
                                                    data-user-id="{{ user.id }}"
                                                    data-user-name="{{ user.name }}"
                                                    data-is-active="{{ user.is_active|tojson|safe }}">
                                                <i class="fas {% if user.is_active %}fa-toggle-off{% else %}fa-toggle-on{% endif %} me-1"></i>
                                                {{ 'تعطيل' if user.is_active else 'تفعيل' }}
                                            </button>
                                        </form>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- الترقيم -->
            {% if users.pages > 1 %}
            <div class="d-flex justify-content-center mt-4">
                <nav>
                    <ul class="pagination">
                        <li class="page-item {% if not users.has_prev %}disabled{% endif %}">
                            <a class="page-link" href="{{ url_for('admin.users', page=users.prev_num) }}" tabindex="-1">
                                <i class="fas fa-chevron-right"></i>
                            </a>
                        </li>
                        
                        {% for page_num in users.iter_pages(left_edge=2, left_current=2, right_current=3, right_edge=2) %}
                            {% if page_num %}
                                {% if users.page == page_num %}
                                <li class="page-item active">
                                    <span class="page-link">{{ page_num }}</span>
                                </li>
                                {% else %}
                                <li class="page-item">
                                    <a class="page-link" href="{{ url_for('admin.users', page=page_num) }}">{{ page_num }}</a>
                                </li>
                                {% endif %}
                            {% else %}
                            <li class="page-item disabled">
                                <span class="page-link">...</span>
                            </li>
                            {% endif %}
                        {% endfor %}
                        
                        <li class="page-item {% if not users.has_next %}disabled{% endif %}">
                            <a class="page-link" href="{{ url_for('admin.users', page=users.next_num) }}">
                                <i class="fas fa-chevron-left"></i>
                            </a>
                        </li>
                    </ul>
                </nav>
            </div>
            {% endif %}
        </main>
    </div>

    <!-- نافذة إضافة مستخدم -->
    <div class="modal fade" id="addUserModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">إضافة مستخدم جديد</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form action="{{ url_for('admin.users') }}" method="post">
                    <div class="modal-body">
                        <div class="row g-4">
                            <!-- البيانات الأساسية -->
                            <div class="col-12">
                                <h6 class="mb-3 fw-bold text-primary">
                                    <i class="fas fa-user-circle me-2"></i>البيانات الأساسية
                                </h6>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="name" class="form-label fw-bold">
                                        <i class="fas fa-user me-2"></i>الاسم الكامل
                                        <span class="text-danger">*</span>
                                    </label>
                                    <input type="text" 
                                           class="form-control form-control-lg" 
                                           id="name" 
                                           name="name" 
                                           placeholder="مثال: محمد أحمد" 
                                           required>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="phone" class="form-label fw-bold">
                                        <i class="fas fa-phone me-2"></i>رقم الهاتف
                                        <span class="text-danger">*</span>
                                    </label>
                                    <input type="tel" 
                                           class="form-control form-control-lg" 
                                           id="phone" 
                                           name="phone" 
                                           placeholder="05xxxxxxxx"
                                           pattern="[0-9]{10}"
                                           required>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="email" class="form-label fw-bold">
                                        <i class="fas fa-envelope me-2"></i>البريد الإلكتروني
                                    </label>
                                    <input type="email" 
                                           class="form-control form-control-lg" 
                                           id="email" 
                                           name="email" 
                                           placeholder="example@domain.com">
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="role" class="form-label fw-bold">
                                        <i class="fas fa-user-tag me-2"></i>نوع الحساب
                                        <span class="text-danger">*</span>
                                    </label>
                                    <select class="form-select form-select-lg" id="role" name="role" required>
                                        <option value="">اختر نوع الحساب</option>
                                        <option value="student">طالب</option>
                                        <option value="teacher">معلم</option>
                                        <option value="assistant">مساعد</option>
                                        <option value="admin">مسؤول</option>
                                    </select>
                                </div>
                            </div>

                            <!-- بيانات الأمان -->
                            <div class="col-12">
                                <hr>
                                <h6 class="mb-3 fw-bold text-primary">
                                    <i class="fas fa-lock me-2"></i>بيانات الأمان
                                </h6>
                            </div>

                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="password" class="form-label fw-bold">
                                        <i class="fas fa-key me-2"></i>كلمة المرور
                                        <span class="text-danger">*</span>
                                    </label>
                                    <div class="input-group">
                                        <input type="password" 
                                               class="form-control form-control-lg" 
                                               id="password" 
                                               name="password" 
                                               required>
                                        <button class="btn btn-outline-secondary" 
                                                type="button" 
                                                id="togglePassword">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    </div>
                                    <small class="text-muted">يجب أن تحتوي على 8 أحرف على الأقل</small>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="password_confirm" class="form-label fw-bold">
                                        <i class="fas fa-key me-2"></i>تأكيد كلمة المرور
                                        <span class="text-danger">*</span>
                                    </label>
                                    <div class="input-group">
                                        <input type="password" 
                                               class="form-control form-control-lg" 
                                               id="password_confirm" 
                                               name="password_confirm" 
                                               required>
                                        <button class="btn btn-outline-secondary" 
                                                type="button" 
                                                id="togglePasswordConfirm">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- الإعدادات الإضافية -->
                            <div class="col-12">
                                <hr>
                                <h6 class="mb-3 fw-bold text-primary">
                                    <i class="fas fa-cog me-2"></i>الإعدادات الإضافية
                                </h6>
                            </div>

                            <div class="col-12">
                                <div class="form-check form-switch">
                                    <input type="checkbox" 
                                           class="form-check-input" 
                                           id="is_active" 
                                           name="is_active" 
                                           checked>
                                    <label class="form-check-label fw-bold" for="is_active">
                                        تفعيل الحساب مباشرة
                                    </label>
                                </div>
                            </div>

                            <div class="col-12" id="teacherOptions" style="display: none;">
                                <div class="form-check form-switch">
                                    <input type="checkbox" 
                                           class="form-check-input" 
                                           id="can_create_classroom" 
                                           name="can_create_classroom">
                                    <label class="form-check-label fw-bold" for="can_create_classroom">
                                        السماح بإنشاء فصول دراسية
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-light" data-bs-dismiss="modal">
                            <i class="fas fa-times me-2"></i>إلغاء
                        </button>
                        <button type="submit" class="btn-custom btn-primary">
                            <i class="fas fa-user-plus me-2"></i>إضافة المستخدم
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- نافذة تعديل مستخدم -->
    <div class="modal fade" id="editUserModal" tabindex="-1" role="dialog" aria-labelledby="editUserModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editUserModalLabel">تعديل بيانات المستخدم</h5>
                    <button class="close" type="button" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">×</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="text-center" id="editUserLoader">
                        <div class="spinner-border text-primary" role="status">
                            <span class="sr-only">جاري التحميل...</span>
                        </div>
                    </div>
                    <form action="#" method="post" id="editUserForm" class="d-none">
                        <!-- Form fields will be loaded via AJAX -->
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- نافذة عرض تفاصيل المستخدم -->
    <div class="modal fade" id="viewUserModal" tabindex="-1" role="dialog" aria-labelledby="viewUserModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="viewUserModalLabel">تفاصيل المستخدم</h5>
                    <button class="close" type="button" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">×</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="text-center" id="userModalLoader">
                        <div class="spinner-border text-primary" role="status">
                            <span class="sr-only">جاري التحميل...</span>
                        </div>
                    </div>
                    <div id="userModalContent" class="d-none">
                        <!-- User details will be loaded here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" type="button" data-dismiss="modal">إغلاق</button>
                </div>
            </div>
        </div>
    </div>

    <!-- نافذة تأكيد تغيير حالة المستخدم -->
    <div class="modal fade" id="confirmStatusModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">تأكيد تغيير الحالة</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p id="confirmStatusMessage"></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>إلغاء
                    </button>
                    <button type="button" class="btn btn-primary" id="confirmStatusBtn">
                        <i class="fas fa-check me-2"></i>تأكيد
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast الإشعارات -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 11;">
        <div id="exportToast" class="toast align-items-center border-0" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body" id="toastMessage">
                    تم تصدير البيانات بنجاح!
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>
    </div>

    <!-- JavaScript Libraries -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.24/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.24/js/dataTables.bootstrap5.min.js"></script>
    <script>
        console.log('Script loaded successfully');
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing...');
            // إعداد القائمة المتنقلة
            const mobileToggle = document.querySelector('.mobile-toggle');
            const mobileNav = document.querySelector('.mobile-nav');

            if (mobileToggle && mobileNav) {
                mobileToggle.addEventListener('click', function() {
                    mobileNav.classList.toggle('show');
                    this.querySelector('i').classList.toggle('fa-bars');
                    this.querySelector('i').classList.toggle('fa-times');
                });

                // إغلاق القائمة عند النقر على أي رابط
                const mobileLinks = document.querySelectorAll('.mobile-nav-link');
                mobileLinks.forEach(link => {
                    link.addEventListener('click', () => {
                        mobileNav.classList.remove('show');
                        mobileToggle.querySelector('i').classList.add('fa-bars');
                        mobileToggle.querySelector('i').classList.remove('fa-times');
                    });
                });

                // إغلاق القائمة عند النقر خارجها
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.mobile-nav') && 
                        !e.target.closest('.mobile-toggle') &&
                        mobileNav.classList.contains('show')) {
                        mobileNav.classList.remove('show');
                        mobileToggle.querySelector('i').classList.add('fa-bars');
                        mobileToggle.querySelector('i').classList.remove('fa-times');
                    }
                });
            }

            // تفعيل DataTable للجداول
            const usersTable = $('#usersTable').DataTable({
                language: {
                    url: "//cdn.datatables.net/plug-ins/1.10.24/i18n/Arabic.json",
                    lengthMenu: "عرض _MENU_ سجل في الصفحة",
                    search: '<i class="fas fa-search ml-2"></i>بحث:',
                    info: "عرض _START_ إلى _END_ من أصل _TOTAL_ سجل",
                    infoEmpty: "لا توجد سجلات متاحة",
                    infoFiltered: "(تم التصفية من _MAX_ سجل)",
                    zeroRecords: '<div class="text-center p-3"><i class="fas fa-search fa-3x text-muted mb-2"></i><br>لا توجد نتائج مطابقة للبحث</div>',
                    emptyTable: '<div class="text-center p-3"><i class="fas fa-users fa-3x text-muted mb-2"></i><br>لا توجد بيانات متاحة</div>',
                    paginate: {
                        first: '<i class="fas fa-angle-double-right"></i>',
                        last: '<i class="fas fa-angle-double-left"></i>',
                        next: '<i class="fas fa-angle-left"></i>',
                        previous: '<i class="fas fa-angle-right"></i>'
                    }
                },
                order: [[4, "desc"]],
                pageLength: 15,
                lengthMenu: [[10, 15, 25, 50, -1], ['10', '15', '25', '50', 'الكل']],
                dom: "<'row'<'col-sm-12 col-md-6'l><'col-sm-12 col-md-6'f>>" +
                     "<'row'<'col-sm-12'tr>>" +
                     "<'row'<'col-sm-12 col-md-5'i><'col-sm-12 col-md-7'p>>",,
                initComplete: function() {
                    // تخصيص حقل البحث
                    $('.dataTables_filter input')
                        .addClass('form-control form-control-lg')
                        .attr('placeholder', 'ابحث عن مستخدم...')
                        .parent()
                        .prepend('<i class="fas fa-search search-icon"></i>');
                    
                    // تخصيص قائمة عدد النتائج
                    $('.dataTables_length select').addClass('form-select form-select-lg');
                    
                    // تحسين مظهر معلومات النتائج
                    $('.dataTables_info').addClass('text-muted');
                },
                drawCallback: function() {
                    // تحسين مظهر أزرار الترقيم
                    $('.paginate_button').addClass('btn btn-sm');
                    $('.paginate_button.current').addClass('btn-primary').removeClass('btn-sm');
                    $('.paginate_button:not(.current)').addClass('btn-light');
                }
            });

            // تصدير البيانات إلى ملف CSV
            $('#exportUsersCSV').on('click', function(e) {
                console.log('CSV button clicked');
                e.preventDefault();
                exportUserData('csv');
            });

            // تصدير البيانات إلى ملف Excel
            $('#exportUsersExcel').on('click', function(e) {
                console.log('Excel button clicked');
                e.preventDefault();
                exportUserData('excel');
            });

            // دالة تصدير البيانات
            function exportUserData(format) {
                const btn = format === 'excel' ? $('#exportUsersExcel') : $('#exportUsersCSV');
                const originalHtml = btn.html();
                
                // تعطيل الزر وإظهار مؤشر التحميل
                btn.prop('disabled', true);
                btn.html('<i class="fas fa-spinner fa-spin"></i> جاري التصدير...');
                
                try {
                    // الحصول على الفلاتر الحالية من النموذج
                    const currentFilters = {};
                    const roleFilter = $('select[name="role"]').val();
                    const statusFilter = $('select[name="status"]').val();
                    const searchFilter = $('input[name="search"]').val();
                    
                    if (roleFilter) currentFilters.role = roleFilter;
                    if (statusFilter) currentFilters.status = statusFilter;
                    if (searchFilter) currentFilters.search = searchFilter;
                    
                    // بناء URL التصدير
                    const baseUrl = format === 'excel' ? '/admin/users/export/excel' : '/admin/users/export';
                    const exportUrl = baseUrl + '?' + new URLSearchParams(currentFilters).toString();
                    
                    if (format === 'excel') {
                        // تصدير Excel - استخدام رابط مباشر
                        const link = document.createElement('a');
                        link.href = exportUrl;
                        link.style.display = 'none';
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        
                        // إظهار رسالة نجاح
                        setTimeout(() => {
                            btn.prop('disabled', false);
                            btn.html('<i class="fas fa-check text-white"></i> تم التصدير بنجاح');
                            showToast('تم تصدير تقرير المستخدمين المفصل بنجاح! يحتوي على 3 أوراق: الملخص التنفيذي، بيانات المستخدمين، والتحليلات البيانية 📊', 'success');
                            
                            setTimeout(() => {
                                btn.html(originalHtml);
                            }, 3000);
                        }, 1000);
                        
                    } else {
                        // تصدير CSV - استخدام AJAX
                        $.ajax({
                            url: exportUrl,
                            method: 'GET',
                            dataType: 'json',
                            success: function(response) {
                                if (response.success && response.data) {
                                    // إنشاء ملف CSV
                                    const csvData = convertToCSV(response.data);
                                    downloadCSV(csvData, 'قائمة_المستخدمين.csv');
                                    
                                    // إظهار رسالة نجاح
                                    btn.prop('disabled', false);
                                    btn.html('<i class="fas fa-check text-white"></i> تم التصدير بنجاح');
                                    showToast(`تم تصدير ${response.total} مستخدم إلى ملف CSV بنجاح! 📄`, 'success');
                                    
                                    setTimeout(() => {
                                        btn.html(originalHtml);
                                    }, 3000);
                                } else {
                                    throw new Error(response.error || 'فشل في جلب البيانات');
                                }
                            },
                            error: function(xhr, status, error) {
                                console.error('خطأ في تصدير CSV:', error);
                                showExportError(btn, originalHtml, 'حدث خطأ أثناء تصدير CSV');
                            }
                        });
                    }
                    
                } catch (error) {
                    console.error('خطأ في التصدير:', error);
                    showExportError(btn, originalHtml, 'حدث خطأ أثناء التصدير');
                }
            }

            // دالة تحويل البيانات إلى CSV
            function convertToCSV(data) {
                const headers = [
                    'الاسم',
                    'رقم الهاتف', 
                    'البريد الإلكتروني',
                    'الصلاحية',
                    'تاريخ التسجيل',
                    'الحالة',
                    'تاريخ آخر تحديث',
                    'العنوان'
                ];

                const csvArray = [headers];
                
                data.forEach(user => {
                    const row = [
                        user.name || '',
                        user.phone || '',
                        user.email || '',
                        user.role || '',
                        user.created_at || '',
                        user.status || '',
                        user.updated_at || '',
                        user.address || ''
                    ];
                    csvArray.push(row);
                });

                // تحويل إلى نص CSV
                return csvArray.map(row => 
                    row.map(cell => `"${String(cell || '').replace(/"/g, '""')}"`).join(',')
                ).join('\r\n');
            }

            // دالة تحميل ملف CSV
            function downloadCSV(csvContent, filename) {
                const BOM = '\uFEFF'; // UTF-8 BOM for Arabic support
                const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8' });
                
                const link = document.createElement('a');
                link.href = window.URL.createObjectURL(blob);
                link.download = filename;
                link.style.display = 'none';
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                window.URL.revokeObjectURL(link.href);
            }

            // دالة عرض خطأ التصدير
            function showExportError(btn, originalText, message = 'فشل في التصدير') {
                btn.prop('disabled', false);
                btn.html('<i class="fas fa-exclamation-triangle text-white"></i> فشل التصدير');
                showToast(message, 'error');
                
                setTimeout(() => {
                    btn.html(originalText);
                }, 3000);
            }

            // دالة إظهار الإشعارات (مبسطة مثل صفحة الفصول)
            function showToast(message, type = 'success') {
                const toastElement = document.getElementById('exportToast');
                const toastBody = document.getElementById('toastMessage');
                
                toastBody.textContent = message;
                
                // تغيير لون التوست حسب النوع
                if (type === 'success') {
                    toastElement.style.background = 'linear-gradient(45deg, #059669, #10B981)';
                } else if (type === 'error') {
                    toastElement.style.background = 'linear-gradient(45deg, #DC2626, #EF4444)';
                } else if (type === 'warning') {
                    toastElement.style.background = 'linear-gradient(45deg, #D97706, #F59E0B)';
                }
                
                // إظهار التوست
                const toast = new bootstrap.Toast(toastElement, {
                    autohide: true,
                    delay: 4000
                });
                toast.show();
            }

            // تفعيل زر القائمة للموبايل
            const menuToggle = document.querySelector('.mobile-toggle');
            const sidebar = document.querySelector('.innovative-sidebar');
            
            if (menuToggle) {
                menuToggle.addEventListener('click', () => {
                    sidebar.classList.toggle('show');
                });
            }
            
            // إغلاق السايدبار عند النقر خارجه
            document.addEventListener('click', (e) => {
                if (window.innerWidth < 992 && 
                    !e.target.closest('.innovative-sidebar') && 
                    !e.target.closest('.mobile-toggle')) {
                    sidebar.classList.remove('show');
                }
            });

            // التحكم في عرض خيارات المعلم
            const roleSelect = document.getElementById('role');
            const teacherOptions = document.getElementById('teacherOptions');
            
            roleSelect.addEventListener('change', function() {
                teacherOptions.style.display = this.value === 'teacher' ? 'block' : 'none';
            });

            // إظهار/إخفاء كلمة المرور
            const togglePassword = document.getElementById('togglePassword');
            const togglePasswordConfirm = document.getElementById('togglePasswordConfirm');
            const password = document.getElementById('password');
            const passwordConfirm = document.getElementById('password_confirm');

            togglePassword.addEventListener('click', function() {
                const type = password.getAttribute('type') === 'password' ? 'text' : 'password';
                password.setAttribute('type', type);
                this.querySelector('i').classList.toggle('fa-eye');
                this.querySelector('i').classList.toggle('fa-eye-slash');
            });

            togglePasswordConfirm.addEventListener('click', function() {
                const type = passwordConfirm.getAttribute('type') === 'password' ? 'text' : 'password';
                passwordConfirm.setAttribute('type', type);
                this.querySelector('i').classList.toggle('fa-eye');
                this.querySelector('i').classList.toggle('fa-eye-slash');
            });

            // التحقق من تطابق كلمات المرور
            const form = document.querySelector('#addUserModal form');
            form.addEventListener('submit', function(e) {
                if (password.value !== passwordConfirm.value) {
                    e.preventDefault();
                    alert('كلمات المرور غير متطابقة');
                }
            });

            // تفعيل أزرار الإجراءات
            // عرض تفاصيل المستخدم
            $(document).on('click', '.view-user', function() {
                const userId = $(this).data('user-id');
                const modal = $('#viewUserModal');
                const loader = $('#userModalLoader');
                const content = $('#userModalContent');

                loader.removeClass('d-none');
                content.addClass('d-none');

                // جلب تفاصيل المستخدم
                $.get(`/admin/users/${userId}/details`)
                    .done(function(data) {
                        content.html(data);
                        content.removeClass('d-none');
                    })
                    .fail(function() {
                        content.html('<div class="alert alert-danger">حدث خطأ أثناء جلب بيانات المستخدم</div>');
                        content.removeClass('d-none');
                    })
                    .always(function() {
                        loader.addClass('d-none');
                    });

                modal.modal('show');
            });

            // تعديل بيانات المستخدم
            $(document).on('click', '.edit-user', function() {
                const userId = $(this).data('user-id');
                const modal = $('#editUserModal');
                const loader = $('#editUserLoader');
                const form = $('#editUserForm');

                loader.removeClass('d-none');
                form.addClass('d-none');

                // جلب نموذج تعديل المستخدم
                $.get(`/admin/users/${userId}/edit`)
                    .done(function(data) {
                        form.html(data);
                        form.removeClass('d-none');
                        
                        // تحديث action النموذج
                        form.attr('action', `/admin/users/${userId}/edit`);
                    })
                    .fail(function() {
                        form.html('<div class="alert alert-danger">حدث خطأ أثناء جلب نموذج التعديل</div>');
                        form.removeClass('d-none');
                    })
                    .always(function() {
                        loader.addClass('d-none');
                    });

                modal.modal('show');
            });

            // حذف مستخدم
            $(document).on('click', '.delete-user', function() {
                const userId = $(this).data('user-id');
                const userName = $(this).data('user-name');

                if (confirm(`هل أنت متأكد من حذف المستخدم "${userName}"؟ لا يمكن التراجع عن هذا الإجراء.`)) {
                    $.post(`/admin/users/${userId}/delete`)
                        .done(function() {
                            // تحديث الجدول
                            window.location.reload();
                        })
                        .fail(function() {
                            alert('حدث خطأ أثناء حذف المستخدم');
                        });
                }
            });

            // تغيير حالة المستخدم (تفعيل/تعطيل)
            let currentUserId;
            let currentIsActive;
            $(document).on('click', '.toggle-user-status', function() {
                currentUserId = $(this).data('user-id');
                currentIsActive = $(this).data('is-active');
                const action = currentIsActive ? 'تعطيل' : 'تفعيل';
                const message = `هل أنت متأكد من ${action} هذا المستخدم؟`;

                // تحديث رسالة التأكيد
                $('#confirmStatusMessage').text(message);

                // إظهار نافذة التأكيد
                $('#confirmStatusModal').modal('show');
            });

            // تأكيد تغيير الحالة
            $('#confirmStatusBtn').on('click', function() {
                const action = currentIsActive ? 'تعطيل' : 'تفعيل';

                $.post(`/admin/users/${currentUserId}/toggle-status`)
                    .done(function() {
                        // تحديث الجدول
                        window.location.reload();
                    })
                    .fail(function() {
                        alert(`حدث خطأ أثناء ${action} المستخدم`);
                    });

                // إغلاق نافذة التأكيد
                $('#confirmStatusModal').modal('hide');
            });

            // إعادة تعيين كلمة المرور
            $(document).on('click', '.reset-password', function() {
                const userId = $(this).data('user-id');
                const userName = $(this).data('user-name');

                if (confirm(`هل أنت متأكد من إعادة تعيين كلمة المرور للمستخدم "${userName}"؟`)) {
                    $.post(`/admin/users/${userId}/reset-password`)
                        .done(function(response) {
                            alert(`تم إعادة تعيين كلمة المرور بنجاح. كلمة المرور الجديدة هي: ${response.password}`);
                        })
                        .fail(function() {
                            alert('حدث خطأ أثناء إعادة تعيين كلمة المرور');
                        });
                }
            });
        });
    </script>
    <script>
        let currentForm = null;

        // عند النقر على زر تغيير الحالة
        $('.toggle-user-status').on('click', function() {
            const button = $(this);
            const userId = button.data('user-id');
            const userName = button.data('user-name');
            const isActive = button.data('is-active');
            currentForm = button.closest('form');

            // تحديث رسالة التأكيد
            const action = isActive ? 'تعطيل' : 'تفعيل';
            $('#confirmStatusMessage').html(`
                <div class="text-center">
                    <i class="fas ${isActive ? 'fa-user-slash' : 'fa-user-check'} fa-2x mb-3 ${isActive ? 'text-warning' : 'text-success'}"></i>
                    <p>هل أنت متأكد من ${action} حساب "${userName}"؟</p>
                </div>
            `);

            // تحديث زر التأكيد
            $('#confirmStatusBtn').removeClass('btn-success btn-warning')
                .addClass(isActive ? 'btn-warning' : 'btn-success')
                .html(`<i class="fas ${isActive ? 'fa-toggle-off' : 'fa-toggle-on'} me-2"></i>${action}`);

            // إظهار نافذة التأكيد
            $('#confirmStatusModal').modal('show');
        });

        // عند النقر على زر التأكيد في النافذة
        $('#confirmStatusBtn').on('click', function() {
            if (currentForm) {
                // إظهار مؤشر التحميل على الزر
                const btn = $(this);
                const originalHtml = btn.html();
                btn.prop('disabled', true)
                    .html('<i class="fas fa-spinner fa-spin me-2"></i>جاري التنفيذ...');

                // تقديم النموذج
                currentForm.submit();
            }
            $('#confirmStatusModal').modal('hide');
        });

        // إعادة تعيين النموذج الحالي عند إغلاق النافذة
        $('#confirmStatusModal').on('hidden.bs.modal', function() {
            currentForm = null;
        });
    </script>
</body>
</html>